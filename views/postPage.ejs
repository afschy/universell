<%- include('components/header', {PageName : PageName}); -%> 

<div class="pt-5" style="width: 40%; margin-left: 30%;">
<div class="card mb-3 shadow-lg back-color-1" >
    
    <div class="container" style="padding: 0;">
        <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
            <ol class="carousel-indicators">
                <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
                <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
                <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
            </ol>
            <div class="carousel-inner" style="height: 20em;">
                <div class="carousel-item active">
                    <img class="d-block w-100" style="height: 20em;" src= <%= images[0].IMAGE  %> alt="First slide">
                </div>
                <% for(let i=1; i<images.length; i++) { %> 
                    <div class="carousel-item">
                        <img class="d-block w-100" style="height: 20em;" src=<%= images[i].IMAGE  %> alt="Second slide">
                    </div>
                <% } %> 
            </div>
            <a class="carousel-control-prev carousel-link" href="#carouselExampleIndicators" role="button" data-slide="prev">
                <i style="font-size: 30px;" class="fa-solid fa-chevron-left"></i>
                <span class="sr-only">Previous</span>
            </a>
            <a class="carousel-control-next carousel-link" href="#carouselExampleIndicators" role="button" data-slide="next">
                <i style="font-size: 30px;" class="fa-solid fa-chevron-right"></i>
                <span class="sr-only">Next</span>
            </a>
        </div>
    </div>



    <!-- <img src="/images/post_placeholder.jpg" class="card-img-top" style="height: 25em;" alt="..."> -->
        

<div class="card-body back-color-1">
    <div class="row">
        <h5 class="card-title col-10"><%=postInfo.PRODUCTNAME%></h5>
        <div class="row col-2 upvote" style="height: 2em;">
            <button id="postUpvoteButton" class="btn col-6 <% if(hasUpvotedPost == 1) { %>  upvoteon <% } else { %> upvoteoff <% } %>"><i class="bi bi-arrow-up-circle"></i></button>
            <p class="col-6" style="font-size: 20px; text-align: center; padding: 0%; margin: 0%; border: solid black; border-width: 1px; border-radius: 0rem 0.25rem 0.25rem 0rem;"><%= postInfo.UPVOTECOUNT %> </p>
        </div>
    </div>

    <p class="card-text"><%=postInfo.DESCRIPTION%></p>
    <p class="card-text">Seller: <%=postInfo.USERNAME%></p>
    <p class="card-text">Price: <%=postInfo.PRICE%></p>

    <% if(postInfo.NEGOTIABLE == 1){ %>
        <p class="card-text">(Price is Negotiable)</p>
    <% }else{ %>
        <p class="card-text">(Price is NOT Negotiable)</p>
    <% } %>

    <p class="card-text"><%=postInfo.REMAINING%> Units Remaining</p>
    <p class="card-text">This post was upvoted by <%=postInfo.UPVOTECOUNT%> people</p>
    <p class="card-text"><small class="text-muted">Created On: <%=postInfo.TIME%></small></p>

    <button class="btn btn-dark btn-block">BUY NOW</button>
    <button class="btn btn-dark btn-block" id="addCartButton">ADD TO CART</button>
</div>
</div>

<a href="" class="card-link text-type-1" style="width: 40%; padding-left: 30%;" id = "commentToggle"> 
    <div class="fs-2 mb-3">
        <h2>
            <i class="bi bi-chevron-down"></i>
            Comments
        </h2>
    </div>
</a>

<% if(commentToggler == 1) { %>
    <% for(let i=0; i < comments.length + 1; i++){ %>
        <div class="card mb-3 back-color-1 shadow-lg" style="max-height: 220px; width: 100%;">
            <div class="row" >
                <% if(i < comments.length) { %>
                <div class="col-4" style="height: 100%; width: 100%;">
                    <img src="/images/post_placeholder.jpg" class="card-img" style="height: 100%; width: 220px;" alt="...">
                </div>
                <div class="col-6" >
                    <div class="card-body" >
                        <p class="card-text"><%= comments[i].USERNAME %></p>
                        <p class="card-text"><%= comments[i].TEXT %></p>
                    </div>
                </div>
                <div class="card-body row col-2 upvote" style="height: 2em;">
                    
                    <button id=<%= "commentUpvoteButton" + i %> class="btn col-6 <% if(comments[i].HASUPVOTED == 1) { %>  upvoteon <% } else { %> upvoteoff <% } %> "><i class="bi bi-arrow-up-circle"></i></button>
                    <p class="col-6" style="font-size: 20px; text-align: center; padding: 0%; margin: 0%; border: solid black; border-width: 1px; border-radius: 0rem 0.25rem 0.25rem 0rem;"><%= comments[i].UPVOUTECOUNT %></p>
                </div>
                <% } else { %>
                    <div class="col-10" style="padding-right: 0;">
                        <div class="card-body" >
                            <input type="text" id="commentText" class="form-control input-lg" placeholder="Search" style="width: 100%;">
                        </div>
                    </div>
                    <div class="col-2" style="padding-left: 0;">
                        <div class="card-body" style="padding-left: 0;">
                            <button id="addComment" class="btn btn-dark btn-block"><i class="fa-solid fa-paper-plane"></i></i></button>
                        </div>
                    </div>
                <% } %> 
            </div>
        </div>
        <% } %> 
<% } %>

<a href="" class="card-link text-type-1" style="width: 40%; padding-left: 30%;" id = "reviewToggle"> 
    <div class="fs-2 mb-3">
        <h2>
            <i class="bi bi-chevron-down"></i>
            Reviews
        </h2>
    </div>
</a>


<% if(reviewToggler == 1) { %>
    <% for(let i=0; i < reviews.length + 1; i++){ %>
        <div class="card mb-3 back-color-1 shadow-lg" style="max-height: 220px; width: 100%;">
            <div class="row" >
                <% if(i < reviews.length) { %> 
                <div class="col-4" style="height: 100%;">
                    <img src="/images/post_placeholder.jpg" class="card-img" style="height: 100%; width: 220px;" alt="...">
                </div>
                <div class="col-6" >
                    <div class="card-body" >
                        <p class="card-text"><%= reviews[i].USERNAME %></p>
                        <p class="card-text"><%= reviews[i].TEXT %></p>
                        <p class="card-text"><%= reviews[i].NUM_STARS %><span class="fa fa-star star"></span></p>
                        
                    </div>
                </div>
                <div class="card-body row col-2 upvote" style="height: 2em;">
                    <button id=<%= "reviewUpvoteButton" + i %> class="btn col-6 <% if(reviews[i].HASUPVOTED == 1) { %>  upvoteon <% } else { %> upvoteoff <% } %>"><i class="bi bi-arrow-up-circle"></i></button>
                    <p class="col-6" style="font-size: 20px; text-align: center; padding: 0%; margin: 0%; border: solid black; border-width: 1px; border-radius: 0rem 0.25rem 0.25rem 0rem;"><%= reviews[i].UPVOTECOUNT %> </p>
                </div>
                <% } else { %>
                    <div class="col-7" style="padding-right: 0;">
                        <div class="card-body" >
                            <input id="reviewText" type="text" class="form-control input-lg" placeholder="Search" style="width: 100%;">
                        </div>
                    </div>
                    <div class="col-3" style="padding: 0; padding-top: 26px; padding-left: 10px;">
                        <div class="card-body" style="padding: 0;">
                            <% for(let i=0; i<5; i++) { %> 
                                <span id=<%= "starNo" + i %> class="fa fa-star star"></span>
                            <% } %> 
                        </div>
                    </div>
                    <div class="col-2" style="padding-left: 0;">
                        <div class="card-body" style="padding-left: 0;">
                            <button id="addReview" class="btn btn-dark btn-block"><i class="fa-solid fa-paper-plane"></i></i></button>
                        </div>
                        
                    </div>
                <% } %>  
            </div>
             
        </div>
        <% } %> 
<% } %>
</div>




<script>
    let post = <%- JSON.stringify(postInfo) %>;

    $(`#addCartButton`).click(function (e) {
        e.preventDefault();
        $.ajax({
        type: "POST",
        url: "/cart/addToCart",
        data: {
            POST_ID : post.POST_ID
        },
        success: function (res) {
            $(`#cartNum`).html("(" + res.cartNum + ")"); 
        },
        error: function (result) {
            alert('error');
        }
        });
    });

    $(`#postUpvoteButton`).click(function (e) {
        console.log("hi");
        e.preventDefault();
        $.ajax({
        type: "POST",
        url: "/posts/toggleUpvote",
        data: {
            POST_ID : post.POST_ID,
            HASUPVOTEDPOST : (<%= hasUpvotedPost %> + 1)%2,
            CONTENTTYPE : "UPD"
        },
        success: function (res) {
            $(document).ajaxStop(function(){
                window.location.reload();
            });
        },
        error: function (result) {
            alert('error');
        }
        });
    });

    let comments = <%- JSON.stringify(comments) %>;

    for (let i = 0; i < comments.length; i++) {
        $(`#commentUpvoteButton${i}`).click(function (e) {
            // console.log(posts[i]);
            e.preventDefault();
            $.ajax({
            type: "POST",
            url: "/cmnt/toggleupvote",
            data: {
                POST_ID : post.POST_ID,
                CMNT_ID : comments[i].CMNT_ID,
                HASUPVOTEDCMNT : (comments[i].HASUPVOTED + 1)%2,
                CONTENTTYPE : "UPD"
            },
            success: function (res) {
                $(document).ajaxStop(function(){
                    window.location.reload();
                });
            },
            error: function (result) {
                alert('error');
            }
            });
        });
    }

    let reviews = <%- JSON.stringify(reviews) %>;

    for (let i = 0; i < reviews.length; i++) {
        $(`#reviewUpvoteButton${i}`).click(function (e) {
            // console.log(posts[i]);
            e.preventDefault();
            $.ajax({
            type: "POST",
            url: "/review/toggleupvote",
            data: {
                POST_ID : post.POST_ID,
                REVIEW_ID : reviews[i].REVIEW_ID,
                HASUPVOTEDREVIEW : (reviews[i].HASUPVOTED + 1)%2,
                CONTENTTYPE : "UPD"
            },
            success: function (res) {
                $(document).ajaxStop(function(){
                    window.location.reload();
                });
            },
            error: function (result) {
                alert('error');
            }
            });
        });
    }

    for(let i=0; i<5; i++){
        $(`#starNo${i}`).click(function (e) {
            for(let j=0; j<5; j++){
                if(j <= i) $(`#starNo${j}`).css("color", "orange");
                else $(`#starNo${j}`).css("color", "black");
            }
        });
    }

    $(`#addComment`).click(function (e) {
        let txt = $(`#commentText`).val();
        e.preventDefault();
        $.ajax({
        type: "POST",
        url: "/cmnt/newcmnt",
        data: {
            POST_ID : post.POST_ID,
            TEXT : txt,
            CONTENTTYPE : "NEW"
        },
        success: function (res) {
            $(document).ajaxStop(function(){
                window.location.reload();
            });
        },
        error: function (result) {
            alert('error');
        }
        });
    });

    $(`#addReview`).click(function (e) {
        let txt = $(`#reviewText`).val();
        let starCount = 0;
        for(let j=0; j<5; j++){
            if($(`#starNo${j}`).css("color") == "rgb(255, 165, 0)") starCount++;
        }
        e.preventDefault();
        $.ajax({
        type: "POST",
        url: "/review/newreview",
        data: {
            POST_ID : post.POST_ID,
            TEXT : txt,
            CONTENTTYPE : "NEW",
            STARS : starCount
        },
        success: function (res) {
            $(document).ajaxStop(function(){
                window.location.reload();
            });
        },
        error: function (result) {
            alert('error');
        }
        });
    });

</script>

<%- include('components/footer'); -%>